
let whitelistAddresses = ['0x6a8bB090384077d45815626E47131bCcEb607FB3','0x7c1ed26a65E3E5B512d83649120Bd147f5bBD09E','0x4d2E1A38d07Eadf5C62CfDaF93547DAe09F1EF83','0xB022fD04B86D2887380067C960637100DBfb82AC','0xc41d05cee27275E7c243C72188ce71AD9431c5Aa','0xEd0Ee6396507A9cc0897bf7812D321d78a51c8B1','0xdA13E7ffEbb240Ba556dA353eaAA88F9Ac30869E','0xA7F36063BdD78D8Ef94fC1e6C04c25404b1B4572','0x12D220FbDA92a9c8f281eA02871aFA70DfDe81e9','0x2B4d1525cFeb20075d9120eCC6Ba438c449986d6','0x6d456d121c3abB3B77aEB731A6D22648e9d48187','0x84eC6fa30fACc494a97e641788dfFBC27b1bC6d9','0x36Cb7AAC18b02D337a4760d4B72748aFAb17817D','0xa272872ED87Bb6d0c0A17097b5663677A337548E','0x6Bffa1a51a450E6193c672Dc55Cb8C7dCBaC0676','0xD6c9706C1f0EE53C12117809dB30CAD05D1C3274','0x7916bda7435256A49284C10acd605D32A0058435','0xB77eF75fd472281207fD01A6D418E5e3ab1EB758','0x34B6466f4aBbe50739248506909FB5C5DB9C508C','0xb2a42bB33509600Ec8029c54B8493c8972eEe2af','0xC07F88966cFB06E319852226416f80627109dD26','0x3241c919aDBB68b0c898bB54Ea1Cc2b9f7416428','0xF7e59A0F64cEE03ECE4C10F87016a51c5ac729ce','0xA087e95f417997a68A96Be87c9B2610040A14a2B','0x5730BEB1FF37EAdb29D8772D626f96d5Eeea8130','0xA93B235bA171c816e21969A836775077a756Eb81','0x9Dae23ef86bFB8B94fe354a6df03785502D41a10','0xf197791EDf7ee7f57E49f536b0801203E48B349e','0x180Fe469Eb42F67dD16Ee976b5883CF09c09459e','0x915E3B03C0f8CC34b75A9a4115a4D9bf1705DB98','0xd330d6096aADf2212EB6e00eA58369BFF934291c','0x3eeA3055287D13fCcbDe41278F9e79c183276C17','0x647dAd7b5910606C21b295f0ABa2F8973D6f5B76','0x0A566270B3659dcdBA017309006B63Cbd3f4f50f','0xb86dEEA2D744d63497f348CA346315112B06BC9f','0xD4E87529FF9D81DE55F284dE5f4C53F4c83a37E9','0x0bCb4e05C1F58557C2db4cb90484F0B79EC5360c','0x288bC8735c9C77b5516A6A665e4b86Ef2778D7D2','0x92370255C94FA9fCC1AB43333B1758371bD50C46','0x50cF0d27A1fB198D4F4b07405e9a3713Af6d6488','0x79bffAd637CE3DfAd66D7916A630Fd90B13ae388','0x168a5383A703592647E7AEc568c6bA95F35BaAD2','0x0CF8b967A0635303304c76bA12C3d9C7999918eD','0x35577F59e140b3f7213c8B2872fce0b1cF5EBbDe','0x9caaC48B0929616B1A49086010DA76CA9091EC08','0xd6a572cd3E391CC301fC3f23331e16D7C927F57A','0xB3Ec4C6C6B6aCa3DCe1ac400A9De37B8757e4B4C','0x2a5B27986D20f7de8Ad82Aa1020a2105AfBf59E9','0x203739622f6def60df2b1e6dcd23d016eb9d6109','0xe2a61d0a77dc937c8fce1caf19c7f5a35b98ffe9','0x6b82e3ee6d788db4a1c5dfee1319f0d8f702cead','0xC7FaB03eecA24CcaB940932559C5565a4cE9cFFb','0xE4336D25e9Ca0703b574a6fd1b342A4d0327bcfa','0xeDcB8a28161f966C5863b8291E80dDFD1eB78491','0x77cbd0fa30F83a249da282e9fE90A86d7936FdE7','0x16Beb6b55F145E4269279B82c040B7435f1088Ee','0x40fbf86c8f625ae8750277efc7498203e8ee24a5','0x6472919cCe45578B3Dd9f0Daf43bAEEc3D538dd8','0x841D5EaCd6a336476a22bD44a70ece92F06b0c8B','0x105443630eebAE36cdAd3a7C546EC0c7C1236fe4','0xa6f4fDE5ae510d1b149c01592c295ce800993b51','0x8Cd3B7D66d9EBAC2cCfC54455F93eac73A26c904','0x44b5bb9eb2b0c485dce190ccab7dca5357475a84','0x907C3d3c4A573b03dFAe9ea45c2A8E7E32E14e12','0xb00dFC3DEA43e71fcF0c73A54F0B0c156627Eabd','0x3ac1C033c6ED5a4fb02014Cb984Aa3A055649E03','0x8366dB5a9dF0bb7C4F0dB30c1693032fFe412fdF','0xb2570d9c03d11Ec3EFfC0D1b357DE512eB6155A8','0x6F25f735d798f8Fc65698941358A30FE02012E39','0x850F6f62d440B7aBEE07b550134D075B2b5cf3f3'];


var contracts_m={
	motorn:{
		address:'0xD719f0277de4DE63A794E23C97c277E64DeEb845',
		abi:[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"baseURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"flipSaleState","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isSaleActive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxMotor","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"merkleRoot","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"numberOfTokens","type":"uint256"},{"internalType":"bytes32[]","name":"_merkleProof","type":"bytes32[]"}],"name":"mintForWhite","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"numberOfTokens","type":"uint256"}],"name":"mintMotor","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pricePer","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"priceWhite","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"_data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"baseURI","type":"string"}],"name":"setBaseURI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"_merkleRoot","type":"bytes32"}],"name":"setMerkleRoot","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenOfOwnerByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"}]
        }
}

var flag = 0;
var provider;
var is_whitelist;
var myAccount;
var flag_white;
var ChainID;
async function metamaskConnect(){

    var modal__connect = document.getElementsByClassName('modal-warp');
    var modal__connect__item = modal__connect[0]
    modal__connect__item.style.display = 'none';

	if (typeof window.ethereum !== 'undefined') {
		var ethereum = window.ethereum
		ethereum.autoRefreshOnNetworkChange = false
		try {
			window.web3 = new Web3(ethereum);
            const enable = await ethereum.enable();
            provider = new Web3(ethereum);
            flag = 0;
            var accounts = await web3.eth.getAccounts();
            myAccount = accounts[0];
            ChainID = ethereum.chainId;
            console.log('id',ChainID)
            is_whitelist = whitelistAddresses.includes(myAccount);
            if(is_whitelist){
                 flag_white = 1;
            }else{
                 flag_white = 0;
            }
            var account1 = myAccount.substr(0,5) + '....' + myAccount.substr(myAccount.length-4, myAccount.length)
			document.getElementById('ConnectWallet').innerText= account1;
			_display()
	        console.log(myAccount)

		} catch (e) {
			alert("Error:"+e);
		}
	} else {
		alert("Install metamask first，pls!");
	}
}

async function Init() {
    if (web3 != undefined) {
        const accounts = await web3.eth.getAccounts();

        myAccount = accounts[0];
        var account1 = myAccount.substr(0,5) + '....' + myAccount.substr(myAccount.length-4, myAccount.length)
		document.getElementById('ConnectWallet').innerText= account1;
		_display()

    }
}

async function _WalletContract() {
    var modal__connect = document.getElementsByClassName('modal-warp');
    var modal__connect__item = modal__connect[0]
    modal__connect__item.style.display = 'none';
    providers.enable().then((res) => {
        web3 = new Web3(providers);
        ChainID = providers.chainId;
		flag = 1;
		web3.eth.getAccounts(function (error, result) {
		myAccount = result[0];
		is_whitelist = whitelistAddresses.includes(result[0]);
		console.log(myAccount);
		if(is_whitelist){
                 flag_white = 1;
            }else{
                 flag_white = 0;
            }
		})
            providers.on("accountsChanged", (accounts) => {
                ChainID = providers.chainId;
                myAccount = result[0];
                is_whitelist = whitelistAddresses.includes(accounts[0]);
                flag = 1;
                if(is_whitelist){
                     flag_white = 1;
                }else{
                     flag_white = 0;
                }
                 _display();
                document.getElementById('ConnectWallet').innerHTML= accounts[0];
            });
            
            providers.on("disconnect", (code, reason) => {
                closeConnect();
            });
            
            Init((accounts) => {
                document.getElementById('ConnectWallet').innerHTML= accounts[0];
                is_whitelist = whitelistAddresses.includes(accounts[0])
                if(is_whitelist){
                    flag_white = 1;
                }else{
                    flag_white = 0;
                }
                 myAccount = accounts[0];
            })

    }).catch((err) => {
        alert("Fail:"+err);
    });
}

async function mint(i){

    if(flag_white==0){

		try {
             if(flag == 0){
                switch_network();
                var ethereum = window.ethereum;
                provider = new Web3(ethereum);
                ChainID = ethereum.chainId;
             }else{
                provider = new Web3(providers);
                ChainID = providers.chainId;
             }
			var contract =new provider.eth.Contract(contracts_m.motorn.abi,contracts_m.motorn.address);
            if((ChainID == '0x38') || (ChainID == 56) ) {

			provider.eth.getAccounts(function (error, result) {
				if (!error){
					var account = result[0];

                    var Value = i * 0.1 *10 **18;
		    	    contract.methods.mintMotor(i).send({from:account,value:Value},function(error,result){
                    }).on('transactionHash', function(hash){
    				   
    				}).on('confirmation', function(confirmationNumber, receipt){
    				    
    				}).on('receipt', function(receipt){
    				    alert('Mint '+i+' NFT success');
    				    document.getElementById('mintg').style.display='block';
    				    ajaxData(myAccount,i);
    				}).on('error', console.error);
				}
			});
            }
            else if(flag==1 && (ChainID != 56)){
            alert('Please link to bsc main network')}
		} catch (e) {
			alert("Error:"+e);
		}
	}else {
	    if(flag == 0){
	            switch_network()
	            var ethereum = window.ethereum;
                provider = new Web3(ethereum);
                ChainID = ethereum.chainId;
             }else{
                provider = new Web3(providers);
                ChainID = providers.chainId;
             }
             ajaxData(myAccount,i);
             console.log('发送请求')
        if((ChainID == '0x38') || (ChainID == 56) ) {
	                var contract =new provider.eth.Contract(contracts_m.motorn.abi,contracts_m.motorn.address);
	                var xhr = new XMLHttpRequest();
                    xhr.withCredentials = true;
                            $.ajax({
                    			type:'GET',
                                url:'/api/get',
                    			data:{name:myAccount},
                    			dataType: "json",
                    			success:function(res){
                    			    var proof = res;
                    				console.log(proof);
        					     var Value = i * 0.06 *10 **18;
        				    	contract.methods.mintForWhite(i,proof).send({from:myAccount,value:Value},function(error,result){
        		                }).on('transactionHash', function(hash){
        
        						}).on('confirmation', function(confirmationNumber, receipt){
        
        						}).on('receipt', function(receipt){
        						  alert('Mint '+i+' NFT success');
        						  document.getElementById('mintg').style.display='block'
                                  ajaxData(myAccount,i);
        						}).on('error', console.error);
        
                    			}
                    		})
                }
        else if(flag==1 &&(ChainID != 56))
        {alert('Please link to bsc main network')}
        }
}

function _display(){
    var exit_account = document.getElementById("cleanwallet");
	exit_account.style.display = 'block'
	document.getElementById("MINT_it").innerText="MINT";
    document.getElementById("mintblock").style.display='flex';
    document.getElementById("MINT_it").style.display='none'
    document.getElementById('nftPrice').style.display='block'
    document.getElementById('nftNum').style.display='block'
    if(flag_white==1){
        document.getElementById('nftPrice').innerHTML="Whitelist: Price 0.033 ETH"
        document.getElementById('nftNum').innerHTML="Whitelist: UP to 5 per wallet"
        document.getElementById("minta").style.display='inline-block'
        document.getElementById("mintb").style.display='inline-block'
        document.getElementById("mintc").style.display='inline-block'
        document.getElementById("mintd").style.display='inline-block'
        document.getElementById("minte").style.display='inline-block'
    }else {
        document.getElementById('nftPrice').innerHTML="Price 0.055 ETH"
        document.getElementById('nftNum').innerHTML=" UP to 5 per wallet"
        document.getElementById("minta").style.display='inline-block'
        document.getElementById("mintb").style.display='inline-block'
        document.getElementById("mintc").style.display='inline-block'
        document.getElementById("mintd").style.display='inline-block'
        document.getElementById("minte").style.display='inline-block'
    }
} 

function closeConnect(){
    var exit_account = document.getElementById("cleanwallet");
	exit_account.style.display = 'none'
	document.getElementById("MINT_it").style.display='inline-block'
	document.getElementById("mintblock").style.display='none';
	document.getElementById("MINT_it").innerText="Please connect wallet first";
	document.getElementById('ConnectWallet').innerText= "Connect Wallet";
	document.getElementById('nftPrice').innerHTML="Price 0.055 ETH"
    document.getElementById('nftNum').innerHTML="UP to 2 per wallet"
    document.getElementById('nftPrice').style.display='none';
    document.getElementById('nftNum').style.display='none';
    document.getElementById('mintg').style.display='none';
}

function show_original(){

    document.getElementById('ConnectMetaMask').innerText= 'Connect MetaMask';
    var mint_NFT = document.getElementById("mint_NFT");
	mint_NFT.style.display="none";
	var mint_NFT_white = document.getElementById("mint_NFT_white");
	mint_NFT_white.style.display="none";
    var MINT_it = document.getElementById("MINT_it");
	MINT_it.style.display="inline-block";
	var exit_account = document.getElementById("exit_account");
	exit_account.style.display="none";
}




function switch_network(){


window.ethereum
    .request({
        method: 'wallet_addEthereumChain',
        params: [
            {
                chainId: '0x38',
                chainName: 'BSC',
                nativeCurrency: {
                    name: 'BNB',
                    symbol: 'BNB',
                    decimals: 18,
                },
                rpcUrls: ['https://bsc-dataseed.binance.org/'],
                blockExplorerUrls: ['https://bscscan.com/'],
            },
        ],
    })
    .then(() => {
        console.log('success')
    })
    .catch((e) => {

    })


}

function ajaxData (address, mint_num) {
    let match = location.search
    var matchObj = {}
    if (match) {
        match = match.replace('?', '')
        let matchList = match.split("&")
        matchList.forEach(element => {
            const s = element.split('=')
            if (s.length == 2) {
                matchObj['invite_Code'] = s[1].trim();
            }
        });
    }
    const now = new Date().getTime()

    var xhr = new XMLHttpRequest();
    xhr.withCredentials = true;
    $.ajax({
        type:'POST',
        // url:"https://motorn.io/promoteApi/uploadUserBehavior",
        url:"https://m.motorn.io/api/uploadUserBehavior",
        data: JSON.stringify({
            timestamp: now,
            address: address,
            invite_code: matchObj['invite_Code'],
            mint_num: mint_num,
            sig: window.SparkMD5.hash(`address=${address}${matchObj['invite_Code'] ? '&invite_code=' + matchObj['invite_Code'] : ''}&timestamp=${now}`)
        }),
        dataType: "json",
        success:function(res){

        }
    })
}
